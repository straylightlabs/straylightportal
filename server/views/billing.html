{% extends 'layouts/dashboard.html' %}

{% block title %}Billing{% endblock %}

{% block content %}
{% if user.stripe.last4 %}
<div class="short-card mdl-card mdl-shadow--2dp">
  <div class="mdl-card__supporting-text">
    Your card ending with {{user.stripe.last4}} is registered in our system.<br>
    Please only proceed if you want to register a different card for billing.
  </div>
</div>
{% endif %}
<form role="form" id="card-form" action="{{base_url}}/user/billing" method="POST">
  <div class="mdl-grid">
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-cell mdl-cell--12-col">
      <input class="mdl-textfield__input" type="text" data-stripe="number" id="number" pattern="[0-9]{1,16}" data-required>
      <label class="mdl-textfield__label" for="number">Card Number</label>
      <span class="mdl-textfield__error">Please input a valid card number</span>
    </div>
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-cell mdl-cell--4-col">
      <input class="mdl-textfield__input" type="text" size="2" maxlength="2" data-stripe="exp_month" id="exp_month" pattern="[0-9]{1,2}" data-required>
      <label class="mdl-textfield__label" for="exp_month">MM</label>
      <span class="mdl-textfield__error">Please input two-digit month</span>
    </div>
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-cell mdl-cell--4-col">
      <input class="mdl-textfield__input" type="text" size="2" maxlength="2" data-stripe="exp_year" id="exp_year" pattern="[0-9]{1,2}" data-required>
      <label class="mdl-textfield__label" for="exp_year">YY</label>
      <span class="mdl-textfield__error">Please input two-digit year</span>
    </div>
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-cell mdl-cell--4-col">
      <input class="mdl-textfield__input" type="text" size="3" maxlength="3" data-stripe="cvc" id="cvc" pattern="[0-9]{1,3}" data-required>
      <label class="mdl-textfield__label" for="cvc">CVC</label>
      <span class="mdl-textfield__error">Please input three-digit CVC</span>
    </div>
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-cell mdl-cell--12-col">
      <input class="mdl-textfield__input" type="text" value="{{user.profile.displayName}}" data-stripe="name" id="name" data-required>
      <label class="mdl-textfield__label" for="name">Card Holder Name</label>
    </div>
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-cell mdl-cell--12-col">
      <input class="mdl-textfield__input" type="text" id="company_name" name="companyName" value="{{user.billing.companyName}}">
      <label class="mdl-textfield__label" for="company_name">Company Name (optional)</label>
    </div>
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-cell mdl-cell--12-col">
      <input class="mdl-textfield__input" type="text" data-stripe="address_line1" id="address_line1" name="addressStreet" value="{{user.billing.address.street}}" data-required>
      <label class="mdl-textfield__label" for="address_line1">Billing Address</label>
    </div>
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-cell mdl-cell--8-col">
      <input class="mdl-textfield__input" type="text" data-stripe="address_city" id="address_city" name="addressCity" value="{{user.billing.address.zip}}" data-required>
      <label class="mdl-textfield__label" for="address_city">City</label>
    </div>
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-cell mdl-cell--6-col">
      <input class="mdl-textfield__input" type="text" data-stripe="address_state" id="address_state" name="addressState" value="{{user.billing.address.state}}" data-required>
      <label class="mdl-textfield__label" for="address_state">Prefecture / State</label>
    </div>
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-cell mdl-cell--6-col">
      <input class="mdl-textfield__input" type="text" data-stripe="address_zip" id="address_zip" pattern="[-0-9]{1,8}" name="addressZip" value="{{user.billing.address.zip}}" data-required>
      <label class="mdl-textfield__label" for="address_zip">Zip Code</label>
      <span class="mdl-textfield__error">Please input valid zip code</span>
    </div>
    <button type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored mdl-cell mdl-cell--6-col">
      {% if user.stripe.plan %}
      Update
      {% else %}
      Save and review
      {% endif %}
    </button>
  </div>
</form>

<script>
jQuery(function($) {
  var cardForm = $('#card-form'),
  cardFormButton = cardForm.find('button');

  cardForm.submit(function(e) {
    e.preventDefault();

    cardFormButton.prop('disabled', true);

    Stripe.card.createToken(cardForm, function(status, response) {
      if (response.error) {
        showToast(response.error.message);
        cardFormButton.prop('disabled', false);
      } else {
        var token = response.id;
        cardForm.append($('<input type="hidden" name="stripeToken" />').val(token));
        cardForm.get(0).submit();
      }
    });

    return false;
  });
});
</script>
{% endblock %}
